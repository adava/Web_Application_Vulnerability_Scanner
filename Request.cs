using HttpParser.Models;
using HttpWebRequestExecutor.Factories;
using HttpWebRequestExecutor.Interfaces;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Text.RegularExpressions;
using System.Threading.Tasks;
using System.Xml;

namespace MicroFocus_Scanner
{
    class Request
    {
        private static IHttpWebRequestFactory Factory;
        string RequestString;
        Regex PlaceHolder;
        public ParsedHttpRequest parsed;

        public Request(string requestString, IHttpWebRequestFactory factory, string pholder)
        {
            Factory = factory;
            RequestString = requestString;
            PlaceHolder = new Regex(pholder);
        }
        public bool modify_request(string value)
        {
            //Console.Write(value);
            Match matched = PlaceHolder.Match(this.RequestString);
            if (matched != null)
            {
                StringBuilder s = new StringBuilder(this.RequestString);
                s.Replace(matched.Value, value);
                //Console.Write();
                this.RequestString = s.ToString();
                return true;
            }
            else
            {
                return false;
            }
        }
        public string send_request()
        {
            try
            {
                this.parsed = HttpParser.Parser.ParseRawRequest(this.RequestString);
                IHttpWebRequest req = Factory.BuildRequest(parsed);

                IHttpWebResponse resp = req.GetResponse();
                string t_o = resp.GetParsedWebResponse().ResponseText;
                return t_o;
            }
            catch (System.Net.WebException wex)
            {
                string ret_s = null;
                using (var stream = wex.Response.GetResponseStream())
                using (var reader = new System.IO.StreamReader(stream))
                {
                    ret_s=reader.ReadToEnd();
                }
                Console.WriteLine($"Web exception caught. {wex.Message}");
                return ret_s;
            }
        }
    }
}
